{
  name: 'level-grammar',
  stages:
  [{ name: 'extend',
     rules: [
       // replace init--node with start-->end
       { lhs: { node: [{ id: "init", label: { name: "init" } },
                       { id: "node", label: { name: "node" } }],
                edge: [{ v: "init", w: "node", label: { name: "edge" } },
                       { v: "node", w: "init", label: { name: "edge" } }] },
         rhs: { node: [{ id: "start", head:["init"], tail:["init"], label: { name: "start", dot: { pos: '${init.label.dot.pos}' } } },
                       { id: "end", head:["node"], tail:["node"], label: { name: "end", dot: { pos: '${node.label.dot.pos}' } } }],
                edge: [{ v: "start", w: "end", label: { name: "path" } }] } },

       // replace a-->b--x with a-->mid-->end
       { weight: 2,
	 lhs: { node: [{ id: "a" },
                       { id: "b", label: { name: "end" } },
                       { id: "x", label: { name: "node" } }],
                edge: [{ v: "a", w: "b", label: { name: "path" } },
		       { v: "b", w: "x", label: { name: "edge" } },
		       { v: "x", w: "b", label: { name: "edge" } }] },
         rhs: { node: [{ id: "a" },
                       { id: "mid", head:["b"], tail:["b"], label: { name: "room", dot: { pos: '${b.label.dot.pos}' } } },
                       { id: "end", head:["x"], tail:["x"], label: { $merge: [ { $eval: '$b.label' },
									       { dot: { pos: '${x.label.dot.pos}' } }] } }],
                edge: [{ v: "a", w: "mid", label: { name: "path" } },
		       { v: "mid", w: "end", label: { name: "path" } }] } },

       // replace a->d with a->d
       //         |  |      |  ^
       //         |  |      v  |
       //         x--y      b->c

       { lhs: { node: [{ id: "a" },
                       { id: "d" },
                       { id: "x", label: { name: "node" } },
                       { id: "y", label: { name: "node" } }],
                edge: [{ v: "a", w: "d", label: { name: "path" } },
		       { v: "a", w: "x", label: { name: "edge" } },
		       { v: "x", w: "a", label: { name: "edge" } },
		       { v: "x", w: "y", label: { name: "edge" } },
		       { v: "y", w: "x", label: { name: "edge" } },
		       { v: "y", w: "d", label: { name: "edge" } },
		       { v: "d", w: "y", label: { name: "edge" } }] },
         rhs: { node: [{ id: "a" },
                       { id: "d" },
                       { id: "b", head:["x"], tail:["x"], label: { name: "room", dot: { pos: '${x.label.dot.pos}' } } },
                       { id: "c", head:["y"], tail:["y"], label: { name: "room", dot: { pos: '${y.label.dot.pos}' } } }],
                edge: [{ v: "a", w: "b", label: { name: "path" } },
		       { v: "b", w: "c", label: { name: "path" } },
		       { v: "c", w: "d", label: { name: "path" } }] } },
       
       // shortcut
       { limit: 3,
	 lhs: { node: [{ id: "a" },
                       { id: "d" },
                       { id: "x", label: { name: "node" } },
                       { id: "y", label: { name: "node" } }],
                edge: [{ v: "a", w: "d", label: { name: "path" } },
		       { v: "a", w: "x", label: { name: "edge" } },
		       { v: "x", w: "a", label: { name: "edge" } },
		       { v: "x", w: "y", label: { name: "edge" } },
		       { v: "y", w: "x", label: { name: "edge" } },
		       { v: "y", w: "d", label: { name: "edge" } },
		       { v: "d", w: "y", label: { name: "edge" } }] },
         rhs: { node: [{ id: "a" },
                       { id: "d" },
                       { id: "b", head:["x"], tail:["x"], label: { name: "room", dot: { pos: '${x.label.dot.pos}' } } },
                       { id: "c", head:["y"], tail:["y"], label: { name: "room", dot: { pos: '${y.label.dot.pos}' } } }],
                edge: [{ v: "a", w: "d", label: { name: "shortcut", dot: { style: "dotted" } } },
		       { v: "a", w: "b", label: { name: "path" } },
		       { v: "b", w: "c", label: { name: "path" } },
		       { v: "c", w: "d", label: { name: "path" } }] } },

       // key-door
       { limit: 2,
	 weight: .5,
	 lhs: { node: [{ id: "a" },
                       { id: "d" },
                       { id: "x", label: { name: "node" } },
                       { id: "y", label: { name: "node" } }],
                edge: [{ v: "a", w: "d", label: { name: "path" } },
		       { v: "a", w: "x", label: { name: "edge" } },
		       { v: "x", w: "a", label: { name: "edge" } },
		       { v: "x", w: "y", label: { name: "edge" } },
		       { v: "y", w: "x", label: { name: "edge" } },
		       { v: "y", w: "d", label: { name: "edge" } },
		       { v: "d", w: "y", label: { name: "edge" } }] },
         rhs: { node: [{ id: "a" },
                       { id: "d" },
                       { id: "b", head:["x"], tail:["x"], label: { name: "room", dot: { pos: '${x.label.dot.pos}' } } },
                       { id: "c", head:["y"], tail:["y"], label: { name: "key", dot: { pos: '${y.label.dot.pos}' } } }],
                edge: [{ v: "a", w: "d", label: { name: "lock", dot: { style: "dotted" } } },
		       { v: "a", w: "b", label: { name: "path" } },
		       { v: "b", w: "c", label: { name: "path" } },
		       { v: "c", w: "a", label: { name: "valve", dot: { style: "dashed" } } }] } },
       
     ] },
   
  { name: 'trim',
     rules: [
       { lhs: { node: [{ id: "a" },
                       { id: "b" }],
                edge: [{ v: "a", w: "b", label: { name: "edge" } }] },
         rhs: { node: [{ id: "a" },
                       { id: "b" }],
                edge: [] } }
     ] }
  ]
}
